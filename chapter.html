<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .locked {
      color: red;
      font-weight: bold;
      font-size: 18px;
    }
    .chapter-content {
      padding: 20px;
      line-height: 1.7;
      margin-bottom: 80px;
    }
    .chapter-views {
      margin-bottom: 10px;
      font-size: 15px;
      color: gray;
    }
    .back-button, .chapter-list-button, .home-button, .next-button {
      position: fixed;
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 999;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .back-button {
      top: 10px; left: 10px;
      background-color: #28a745; color: white;
    }
    .chapter-list-button {
      top: 60px; left: 10px;
      background-color: #28a745; color: white;
    }
    .home-button {
      top: 110px; left: 10px;
      background-color: #ffc107; color: black;
    }
    .next-button {
      bottom: 10px; right: 10px;
      background-color: #007bff; color: white;
      border-radius: 6px;
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%; max-width: 400px;
      text-align: center;
      position: relative;
    }
    .modal-content h2 { margin-top: 0; }
    .modal-content button {
      padding: 10px 18px; margin: 10px 5px;
      font-size: 16px; border: none;
      border-radius: 5px; cursor: pointer;
    }
    .confirm-btn { background-color: #007bff; color: white; }
    .cancel-btn { background-color: #ccc; }
    .add-coins-btn { background-color: #ffc107; color: black; }
    .close-btn {
      position: absolute; top: 10px; right: 10px;
      background: none; border: none; font-size: 20px; cursor: pointer;
    }
    #chapter-content.dark {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-radius: 10px;
      padding: 20px;
    }
    #chapter-content.dark h1 { color: #ffffff; }
    #chapter-content.dark p { color: #cccccc; }
  </style>
</head>
<body>
  <button class="back-button" onclick="history.back()">‚Üê Back</button>
  <button id="chapterListBtn" class="chapter-list-button" style="display:none;">‚Üê Back to Chapter List</button>
  <button class="home-button" onclick="window.location.href='index.html'">üè† Back to Homepage</button>

  <div id="darkModeToggleWrapper">
    <label>
      <input type="checkbox" id="darkModeToggle" />
      Dark Mode for Chapter
    </label>
  </div>

  <div id="chapter-content" class="chapter-content"></div>
  <button class="next-button" onclick="goToNextChapter()">Next Chapter ‚Üí</button>

  <div id="unlock-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">√ó</button>
      <h2>Unlock Chapter?</h2>
      <p>This chapter costs <strong id="coinCost"></strong> coins.</p>
      <p>You have <strong id="userCoins"></strong> coins.</p>
      <div id="modal-actions"></div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://jkjfdgjgjpybnixqwiou.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    );

    const urlParams = new URLSearchParams(window.location.search);
    const chapterId = urlParams.get('id');
    let currentChapterId = chapterId;

    checkSession();

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      const stored = localStorage.getItem('session');

      if (session?.user) {
        localStorage.setItem('session', JSON.stringify(session));
        document.getElementById("darkModeToggleWrapper").style.display = "block";
        loadChapter(session.user.id);
      } else if (stored) {
        const parsed = JSON.parse(stored);
        const { data } = await supabase.auth.setSession({
          access_token: parsed.access_token,
          refresh_token: parsed.refresh_token
        });
        if (data?.session?.user) {
          document.getElementById("darkModeToggleWrapper").style.display = "block";
          return loadChapter(data.session.user.id);
        }
        return loadChapter(null);
      } else {
        return loadChapter(null);
      }
    }

    async function loadChapter(userId) {
      const container = document.getElementById('chapter-content');
      const { data: chapter, error } = await supabase
        .from('chapters')
        .select('*')
        .eq('id', currentChapterId)
        .single();

      if (error || !chapter) {
        container.innerHTML = "<p>‚ùå Error loading chapter.</p>";
        return;
      }

      if (chapter.locked && chapter.coin_cost > 0 && !userId) {
        return window.location.href = "auth.html";
      }

      // Increment views
      await supabase
        .from('chapters')
        .update({ views: (chapter.views || 0) + 1 })
        .eq('id', currentChapterId);

      container.innerHTML = `
        <h1>${chapter.title}</h1>
        <p class="chapter-views">üëÅÔ∏è Views: ${chapter.views || 0}</p>
        ${chapter.content}
      `;

      const chapterListBtn = document.getElementById('chapterListBtn');
      chapterListBtn.style.display = 'block';
      chapterListBtn.onclick = () => {
        window.location.href = `book.html?id=${chapter.book_id}`;
      };

      const isDark = localStorage.getItem("chapterDarkMode") === "true";
      const toggle = document.getElementById("darkModeToggle");
      if (toggle) toggle.checked = isDark;
      if (isDark) container.classList.add("dark");
    }

    async function goToNextChapter() {
      const { data: currentChapter } = await supabase
        .from('chapters')
        .select('chapter_number, book_id')
        .eq('id', currentChapterId)
        .single();

      const { chapter_number, book_id } = currentChapter;
      const { data: nextChapters } = await supabase
        .from('chapters')
        .select('id')
        .eq('book_id', book_id)
        .gt('chapter_number', chapter_number)
        .order('chapter_number', { ascending: true })
        .limit(1);

      if (!nextChapters?.length) {
        alert("üö´ This is the last chapter.");
        return;
      }

      const nextChapter = nextChapters[0];
      window.location.href = `chapter.html?id=${nextChapter.id}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("darkModeToggle");
      const content = document.getElementById("chapter-content");

      if (toggle) {
        toggle.addEventListener("change", () => {
          const enabled = toggle.checked;
          content.classList.toggle("dark", enabled);
          localStorage.setItem("chapterDarkMode", enabled);
        });
      }
    });
  </script>
</body>
</html>
